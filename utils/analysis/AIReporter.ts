import { FullResult, Reporter, TestCase, TestResult } from '@playwright/test/reporter';
import * as fs from 'fs';
import * as path from 'path';
import { analyzeSummary, FailureDetail, TestRunSummary } from './ai-test-analyzer';

class AIReporter implements Reporter {
  private failures: FailureDetail[] = [];
  private totalTests = 0;
  private passedTests = 0;
  private failedTests = 0;
  private brokenTests = 0;
  private skippedTests = 0;

  onTestEnd(test: TestCase, result: TestResult) {
    this.totalTests++;
    switch (result.status) {
      case 'passed':
        this.passedTests++;
        break;
      case 'failed':
        this.failedTests++;
        this.addFailure(test, result);
        break;
      case 'timedOut':
        this.brokenTests++;
        this.addFailure(test, result);
        break;
      case 'skipped':
        this.skippedTests++;
        break;
      case 'interrupted':
        this.brokenTests++;
        break;
    }
  }

  private addFailure(test: TestCase, result: TestResult) {
    this.failures.push({
      name: test.title,
      file: test.location.file,
      error: result.error?.message || 'Unknown error',
      trace: result.error?.stack || '',
    });
  }

  async onEnd(result: FullResult) {
    if (this.failedTests === 0 && this.brokenTests === 0) {
      console.log('\nâœ… All tests passed. Skipping AI summary.');
      return;
    }

    const summary: TestRunSummary = {
      total: this.totalTests,
      passed: this.passedTests,
      failed: this.failedTests,
      broken: this.brokenTests,
      skipped: this.skippedTests,
      failures: this.failures,
    };

    console.log('\nğŸ¤– Generating AI Test Summary...');
    const aiAnalysis = await analyzeSummary(summary);

    const report = this.formatMarkdownReport(summary, aiAnalysis);

    // Save to file
    const outputPath = path.join(process.cwd(), 'ai-analysis-report.md');
    fs.writeFileSync(outputPath, report);

    // Also log to console for visibility in CI
    console.log('\n=== AI TEST ANALYSIS ===\n');
    console.log(aiAnalysis);
    console.log('\n========================\n');
    console.log(`Report saved to: ${outputPath}`);

    // If running in GitHub Actions, add to Step Summary
    if (process.env.GITHUB_STEP_SUMMARY) {
      fs.appendFileSync(process.env.GITHUB_STEP_SUMMARY, report);
    }
  }

  private formatMarkdownReport(summary: TestRunSummary, aiAnalysis: string): string {
    const timestamp = new Date().toISOString();
    return `# ğŸ¤– AI Test Analysis Report

> Generated: ${timestamp}

## ğŸ“Š Summary

| Metric | Value |
|--------|-------|
| Total Tests | ${summary.total} |
| âœ… Passed | ${summary.passed} |
| âŒ Failed | ${summary.failed} |
| ğŸ’” Broken | ${summary.broken} |
| â­ï¸ Skipped | ${summary.skipped} |

---

${aiAnalysis}

---
*This report was generated by AI.*
`;
  }
}

export default AIReporter;
