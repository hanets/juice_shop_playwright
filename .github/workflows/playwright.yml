name: Playwright Tests
on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

permissions:
  contents: read
  pages: write
  id-token: write

jobs:
  test:
    timeout-minutes: 60
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Checkout Juice Shop
      uses: actions/checkout@v4
      with:
        repository: juice-shop/juice-shop
        path: juice-shop
        
    - uses: actions/setup-node@v4
      with:
        node-version: lts/*
        
    - name: Install and Start Juice Shop
      working-directory: juice-shop
      run: |
        npm install
        npm start &
        npx wait-on http://localhost:3000
        
    - name: Install dependencies
      run: npm ci
      
    - name: Install Playwright Browsers
      run: npx playwright install --with-deps
      
    - name: Run Playwright tests
      run: npx playwright test
      env:
        BASE_URL: http://localhost:3000/
    
    - name: Generate Allure Report
      if: always()
      run: npx allure generate allure-results --clean -o allure-report
      
    - name: Setup Pages
      if: always()
      run: |
        mkdir -p public/playwright
        mkdir -p public/allure
        cp -r playwright-report/* public/playwright/
        cp -r allure-report/* public/allure/
        echo '<!DOCTYPE html><html><head><meta charset="utf-8"><title>Test Reports</title><style>body{font-family:sans-serif;margin:2rem;display:flex;gap:2rem;justify-content:center;align-items:center;height:100vh;background:#f5f5f5;}a{display:block;padding:1.5rem 3rem;background:#fff;text-decoration:none;color:#333;border-radius:8px;box-shadow:0 2px 5px rgba(0,0,0,0.1);font-size:1.2rem;transition:all 0.2s;}a:hover{transform:translateY(-2px);box-shadow:0 4px 8px rgba(0,0,0,0.15);}</style></head><body><a href="playwright/index.html">Playwright Report</a><a href="allure/index.html">Allure Report</a></body></html>' > public/index.html
        
    - uses: actions/upload-pages-artifact@v3
      if: always()
      with:
        path: public/
        
    - uses: actions/deploy-pages@v4
      if: always()
