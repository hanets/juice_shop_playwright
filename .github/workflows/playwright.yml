name: Playwright Tests
on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]
  workflow_dispatch:
    inputs:
      grep:
        description: 'Grep pattern for tests (file name or test name)'
        required: false
        type: string
      project:
        description: 'Browser/Project to run'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - chromium
          - firefox
          - webkit

permissions:
  contents: read
  pages: write
  id-token: write

# Allow only one concurrent deployment, skipping runs queued between the run in-progress and latest queued.
# However, do NOT cancel in-progress runs as we want to allow these production deployments to complete.
concurrency:
  group: 'pages'
  cancel-in-progress: false

jobs:
  test:
    timeout-minutes: 60
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: lts/*
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run ESLint
        run: npm run lint

      - name: Run Prettier
        run: npm run format

      - name: Checkout Juice Shop
        uses: actions/checkout@v4
        with:
          repository: juice-shop/juice-shop
          path: juice-shop

      - name: Install and Start Juice Shop
        working-directory: juice-shop
        run: |
          npm install
          npm start &
          npx wait-on http://localhost:3000

      - name: Install Playwright Browsers
        run: npx playwright install --with-deps

      - name: Run Playwright tests
        run: |
          ARGS=""
          if [ -n "${{ inputs.grep }}" ]; then
            ARGS="$ARGS -g \"${{ inputs.grep }}\""
          fi
          if [ "${{ inputs.project }}" != "all" ] && [ -n "${{ inputs.project }}" ]; then
            ARGS="$ARGS --project=${{ inputs.project }}"
          fi
          # Default run if no inputs (push/pr) or 'all' selected
          echo "Running with args: $ARGS"
          eval npx playwright test $ARGS
        env:
          BASE_URL: http://localhost:3000/
          DB_HOST: ${{ secrets.DB_HOST }}
          DB_PORT: ${{ secrets.DB_PORT }}
          DB_USER: ${{ secrets.DB_USER }}
          DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
          DB_DATABASE: ${{ secrets.DB_DATABASE }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}

      - name: Get Allure history
        uses: actions/checkout@v4
        if: always()
        continue-on-error: true
        with:
          ref: gh-pages
          path: gh-pages

      - name: Debug - Check gh-pages structure
        if: always()
        run: |
          echo "=== Checking gh-pages structure ==="
          ls -la gh-pages/ || echo "gh-pages directory not found"
          ls -la gh-pages/allure/ || echo "gh-pages/allure directory not found"
          ls -la gh-pages/allure/history/ || echo "gh-pages/allure/history directory not found"

      - name: Restore Allure history
        if: always()
        run: |
          mkdir -p allure-results/history
          if [ -d "gh-pages/allure/history" ] && [ "$(ls -A gh-pages/allure/history 2>/dev/null)" ]; then
            cp -r gh-pages/allure/history/* allure-results/history/
            echo "=== History restored from gh-pages ==="
          else
            echo "=== No previous history found, starting fresh ==="
          fi
          ls -la allure-results/history/ || echo "No history files found"

      - name: Add Allure Executor Information
        if: always()
        run: |
          echo "{\"name\":\"GitHub Actions\",\"type\":\"github\",\"url\":\"${{ github.server_url }}/${{ github.repository }}\",\"buildOrder\":${{ github.run_number }},\"buildName\":\"#${{ github.run_number }}\",\"buildUrl\":\"${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}\"}" > allure-results/executor.json

      - name: Generate Allure Report
        if: always()
        run: npx allure generate allure-results --clean -o allure-report

      - name: Debug - Check generated report structure
        if: always()
        run: |
          echo "=== Checking generated report structure ==="
          ls -la allure-report/
          ls -la allure-report/history/ || echo "allure-report/history directory not found"

      - name: Prepare reports for upload
        if: always()
        run: |
          mkdir -p public/playwright
          mkdir -p public/allure

          if [ -d "playwright-report" ]; then
            cp -r playwright-report/* public/playwright/
          else
            echo "Warning: playwright-report directory not found"
          fi

          if [ -d "allure-report" ]; then
            cp -r allure-report/* public/allure/
          else
            echo "Warning: allure-report directory not found"
          fi

          # Include AI analysis report if it exists
          if [ -f "ai-analysis-report.md" ]; then
            cp ai-analysis-report.md public/
          fi

          echo '<!DOCTYPE html><html><head><meta charset="utf-8"><title>Test Reports</title><style>body{font-family:sans-serif;margin:2rem;display:flex;gap:2rem;justify-content:center;align-items:center;height:100vh;background:#f5f5f5;}a{display:block;padding:1.5rem 3rem;background:#fff;text-decoration:none;color:#333;border-radius:8px;box-shadow:0 2px 5px rgba(0,0,0,0.1);font-size:1.2rem;transition:all 0.2s;}a:hover{transform:translateY(-2px);box-shadow:0 4px 8px rgba(0,0,0,0.15);}</style></head><body><a href="playwright/index.html">Playwright Report</a><a href="allure/index.html">Allure Report</a></body></html>' > public/index.html

      - name: Upload test reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-reports
          path: public/
          retention-days: 30

      - name: Upload Allure results (raw JSON for record)
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: allure-results
          path: allure-results/
          retention-days: 7

  # Deploy job
  deploy:
    # Add a dependency to the build job
    needs: test
    # Only deploy on push to main/master, not on pull requests
    if: always() && (github.event_name == 'push' || github.event_name == 'workflow_dispatch') && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')

    # Grant GITHUB_TOKEN the permissions required to push to gh-pages
    permissions:
      contents: write # allow pushing to gh-pages branch
      pages: write # retained if using Pages in the future
      id-token: write # retained for compatibility

    # Deploy to the github-pages environment
    environment:
      name: github-pages

    # Specify runner + deployment step
    runs-on: ubuntu-latest
    steps:
      - name: Download test reports
        uses: actions/download-artifact@v4
        with:
          name: test-reports
          path: ./public

      - name: Deploy to GitHub Pages
        id: deployment
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_branch: gh-pages
          publish_dir: public
